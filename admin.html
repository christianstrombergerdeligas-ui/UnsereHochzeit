<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin-Panel - Unsere Hochzeit</title>
  <link href="style.css" rel="stylesheet">
  <script src="admin.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Unsere Hochzeit</h1>
      <button id="hamburger" class="hamburger">â˜°</button>
      <button id="adminToggle" class="admin-toggle" title="Admin">ğŸ”’</button>
    </div>
    <nav id="navMenu">
      <a href="index.html">Start</a>
      <a href="geschichte.html" id="historyLink" style="display:none;">Unsere Geschichte</a>
      <a href="termine.html">Termine & Orte</a>
      <a href="anmeldung.html">Anmeldung zur Feier</a>
      <a href="ablaufplan.html" id="ablaufplanLink" style="display:none;">Ablaufplan</a>
      <a href="buffet.html" id="buffetLink" style="display:none;">Buffet MenÃ¼</a>
      <a href="fotos.html">Fotos</a>
      <a href="gaestebuch.html" id="guestbookLink" style="display:none;">GÃ¤stebuch</a>
      <a href="danksagung.html" id="danksagungLink" style="display:none;">Danksagung</a>
      <a href="admin.html" id="adminLink" style="display:none;">âš™ï¸ Admin</a>
    </nav>
  </header>

  <main>
    <section id="adminOnlySection" style="display:none;">
      <h2>ğŸ“Š Admin-Panel</h2>
      <p>Hier kÃ¶nnen Sie die Hochzeitsdaten verwalten und exportieren.</p>

      <section style="background-color: #E1F5FE; margin-top: 2rem;">
        <h3>ğŸ” Feature-Status Ãœbersicht</h3>
        <p>Welche Seiten sind aktuell fÃ¼r GÃ¤ste sichtbar?</p>
        <div style="text-align: left; max-width: 600px; margin: 1rem auto; padding: 1rem; background-color: #FFF9F0; border-radius: 8px;">
          <ul style="list-style: none; padding: 0;">
            <li style="padding: 0.5rem 0; border-bottom: 1px solid #ddd;">
              <strong>Ablaufplan:</strong> <span id="ablaufplanStatus">ğŸ”’ Versteckt bis 01.05.2026</span>
            </li>
            <li style="padding: 0.5rem 0; border-bottom: 1px solid #ddd;">
              <strong>Buffet MenÃ¼:</strong> <span id="buffetStatus">ğŸ”’ Versteckt bis 01.05.2026</span>
            </li>
            <li style="padding: 0.5rem 0; border-bottom: 1px solid #ddd;">
              <strong>GÃ¤stebuch:</strong> <span id="guestbookStatus">ğŸ”’ Versteckt bis 15.05.2026</span>
            </li>
            <li style="padding: 0.5rem 0; border-bottom: 1px solid #ddd;">
              <strong>Danksagung:</strong> <span id="danksagungStatus">ğŸ”’ Versteckt bis 16.05.2026</span>
            </li>
            <li style="padding: 0.5rem 0;">
              <strong>Unsere Geschichte:</strong> <span style="color: #6B8E72;">ğŸ”’ Nur Admin (immer)</span>
            </li>
          </ul>
        </div>
      </section>

      <section style="background-color: #F3E5F5; margin-top: 2rem;">
        <h3>ğŸ“‹ Google Sheets Anmeldungen</h3>
        <p>Alle Anmeldungen direkt in Google Sheets ansehen</p>
        <a href="https://docs.google.com/spreadsheets/d/1pHiCuhNfCphu-kKfhQZCjK4CdD8iYDgTXxTt3iL1QH8/edit" target="_blank" style="display: inline-block; padding: 0.7rem 1.5rem; background-color: #6B8E72; color: white; text-decoration: none; border-radius: 12px; font-weight: bold; margin-top: 1rem; transition: 0.3s;">
          Sheets Ã¶ffnen
        </a>
      </section>

      <section style="background-color: #F3E5F5; margin-top: 2rem;">
        <h3>ğŸ“” Google Sheets GÃ¤stebuch</h3>
        <p>Alle GÃ¤stebucheintrÃ¤ge direkt in Google Sheets ansehen</p>
        <a href="https://docs.google.com/spreadsheets/d/1FUX4_U9ZZ9qPX97uGUVOy9RVefLf7loBMCz5I2VySsY/edit" target="_blank" style="display: inline-block; padding: 0.7rem 1.5rem; background-color: #6B8E72; color: white; text-decoration: none; border-radius: 12px; font-weight: bold; margin-top: 1rem; transition: 0.3s;">
          Sheets Ã¶ffnen
        </a>
      </section>

      <section style="background-color: #E8EAF6; margin-top: 2rem;">
        <h3>ğŸ“¸ Google Photos Album</h3>
        <p>Alle hochgeladenen Fotos ansehen und verwalten</p>
        <a href="https://photos.app.goo.gl/TNup4TKHrsxtD7hz8" target="_blank" style="display: inline-block; padding: 0.7rem 1.5rem; background-color: #6B8E72; color: white; text-decoration: none; border-radius: 12px; font-weight: bold; margin-top: 1rem; transition: 0.3s;">
          Album Ã¶ffnen
        </a>
      </section>

      <section style="background-color: #F1F8E9; margin-top: 2rem;">
        <h3>âœï¸ Content Editor</h3>
        <p>Bearbeite Inhalte direkt auf dieser Seite. Ã„nderungen werden zu GitHub hochgeladen.</p>
        
        <div style="margin-top: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ“– Seite wÃ¤hlen:</label>
          <select id="pageSelector" style="width: 100%; max-width: 500px; padding: 0.5rem; border-radius: 8px; border: 1px solid #d6e8d2;">
            <option value="">-- Seite auswÃ¤hlen --</option>
            <option value="startseite">Startseite</option>
            <option value="geschichte">Unsere Geschichte</option>
            <option value="buffet">Buffet MenÃ¼</option>
            <option value="ablaufplan">Ablaufplan</option>
            <option value="danksagung">Danksagung</option>
          </select>
        </div>

        <div id="editorContainer" style="margin-top: 1.5rem; display: none;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ“ Inhalt:</label>
          <textarea id="contentEditor" style="width: 100%; max-width: 500px; min-height: 200px; padding: 0.75rem; border-radius: 8px; border: 1px solid #d6e8d2; font-family: 'Roboto', monospace; font-size: 0.9rem;"></textarea>
          
          <div style="margin-top: 1rem; display: flex; gap: 1rem;">
            <button id="saveContentBtn" style="background-color: #4CAF50;">ğŸ’¾ Speichern & Hochladen</button>
            <button id="cancelContentBtn" style="background-color: #999;">Abbrechen</button>
          </div>
          <p id="editorStatus" style="margin-top: 0.5rem; font-size: 0.9rem; color: #6B8E72;"></p>
        </div>
      </section>
    </section>

    <section id="notAdminSection">
      <h2>Zugriff verweigert</h2>
      <p>Diese Seite ist nur im Admin-Modus verfÃ¼gbar.</p>
      <p>Bitte melden Sie sich mit dem Admin-Passwort an.</p>
    </section>
  </main>

  <footer>
    Â© 2026 Jenica und Christian
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const adminSection = document.getElementById('adminOnlySection');
    const notAdminSection = document.getElementById('notAdminSection');

    function updateAdminView() {
      if (window.isAdminMode && window.isAdminMode()) {
        adminSection.style.display = 'block';
        notAdminSection.style.display = 'none';
        setupExportButtons();
      } else {
        adminSection.style.display = 'none';
        notAdminSection.style.display = 'block';
      }
    }

    function setupExportButtons() {
      // Feature-Status aktualisieren
      updateFeatureStatus();
      
      // QR-Code generieren
      generateQRCode();
    }

    function updateFeatureStatus() {
      const today = new Date();
      const ablaufplanDate = new Date(2026, 4, 1);
      const buffetDate = new Date(2026, 4, 1);
      const guestbookDate = new Date(2026, 4, 15);
      const danksagungDate = new Date(2026, 4, 16);

      document.getElementById('ablaufplanStatus').innerHTML = 
        today >= ablaufplanDate ? 'âœ… Sichtbar fÃ¼r alle' : 'ğŸ”’ Versteckt bis 01.05.2026';
      document.getElementById('buffetStatus').innerHTML = 
        today >= buffetDate ? 'âœ… Sichtbar fÃ¼r alle' : 'ğŸ”’ Versteckt bis 01.05.2026';
      document.getElementById('guestbookStatus').innerHTML = 
        today >= guestbookDate ? 'âœ… Sichtbar fÃ¼r alle' : 'ğŸ”’ Versteckt bis 15.05.2026';
      document.getElementById('danksagungStatus').innerHTML = 
        today >= danksagungDate ? 'âœ… Sichtbar fÃ¼r alle' : 'ğŸ”’ Versteckt bis 16.05.2026';
    }

    function generateQRCode() {
      const qrcodeContainer = document.getElementById('qrcode');
      qrcodeContainer.innerHTML = '';
      new QRCode(qrcodeContainer, {
        text: window.location.origin + '/index.html',
        width: 200,
        height: 200,
        colorDark: '#3C5A40',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    // ===== Content Editor fÃ¼r GitHub via Worker =====
    const WORKER_URL = 'https://wedding-content-api.christianstrombergerdeligas-ui.workers.dev';

    const contentBlocks = {
      startseite: { file: 'index.html' },
      geschichte: { file: 'geschichte.html' },
      buffet: { file: 'buffet.html' },
      ablaufplan: { file: 'ablaufplan.html' },
      danksagung: { file: 'danksagung.html' }
    };

    document.getElementById('pageSelector').addEventListener('change', async (e) => {
      const page = e.target.value;
      if (!page) {
        document.getElementById('editorContainer').style.display = 'none';
        return;
      }
      
      const container = document.getElementById('editorContainer');
      const textarea = document.getElementById('contentEditor');
      const status = document.getElementById('editorStatus');
      
      container.style.display = 'block';
      status.textContent = 'â³ Inhalt wird geladen...';
      
      try {
        const content = await loadContentFromWorker(page);
        textarea.value = content;
        status.textContent = 'âœ… Inhalt geladen';
      } catch (error) {
        status.textContent = 'âŒ Fehler beim Laden: ' + error.message;
      }
    });

    document.getElementById('saveContentBtn').addEventListener('click', async () => {
      const page = document.getElementById('pageSelector').value;
      const content = document.getElementById('contentEditor').value;
      const status = document.getElementById('editorStatus');
      
      if (!window.isAdminMode || !window.isAdminMode()) {
        status.textContent = 'âŒ Nur Admin kann speichern!';
        return;
      }
      
      status.textContent = 'â³ Speichern...';
      
      try {
        await saveContentToWorker(page, content);
        status.textContent = 'âœ… Erfolgreich gespeichert! Deploy lÃ¤uft...';
      } catch (error) {
        status.textContent = 'âŒ Fehler: ' + error.message;
      }
    });

    document.getElementById('cancelContentBtn').addEventListener('click', () => {
      document.getElementById('pageSelector').value = '';
      document.getElementById('editorContainer').style.display = 'none';
      document.getElementById('contentEditor').value = '';
    });

    async function loadContentFromWorker(page) {
      try {
        const response = await fetch(`${WORKER_URL}/api/content/${page}`, {
          headers: {
            'Authorization': 'Bearer admin-session'
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => response.statusText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        return data.content;
      } catch (error) {
        if (error.message.includes('Failed to fetch')) {
          throw new Error('Worker nicht erreichbar. CORS-Problem oder Worker offline?');
        }
        throw error;
      }
    }

    async function saveContentToWorker(page, newContent) {
      try {
        const response = await fetch(`${WORKER_URL}/api/content/${page}`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer admin-session',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ content: newContent })
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => response.statusText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        return true;
      } catch (error) {
        if (error.message.includes('Failed to fetch')) {
          throw new Error('Worker nicht erreichbar. CORS-Problem oder Worker offline?');
        }
        throw error;
      }
    }

    updateAdminView();
    window.addEventListener('adminStateChanged', updateAdminView);
  });
  </script>
</body>
</html>
